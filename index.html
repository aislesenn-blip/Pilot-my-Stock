<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot my Stock | Enterprise Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F5F5F7; }
        .glass { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .input-field { background: #FFFFFF; border: 1px solid #E5E5E5; transition: all 0.2s; }
        .input-field:focus { border-color: #000; outline: none; ring: 1px solid #000; }
        .btn-black { background: #111; color: #fff; transition: all 0.2s; }
        .btn-black:hover { background: #000; transform: translateY(-1px); }
        .hidden { display: none; }
    </style>
</head>
<body class="flex items-center justify-center h-screen px-4">

    <div class="glass w-full max-w-[420px] p-10 rounded-3xl animate-fade-in">
        <div class="mb-8">
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Pilot my Stock.</h1>
            <p class="text-xs text-gray-500 mt-2 font-medium tracking-wide">ENTERPRISE OPERATING SYSTEM</p>
        </div>

        <div class="flex p-1 bg-gray-100 rounded-xl mb-8">
            <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-2.5 text-sm font-semibold rounded-lg bg-white shadow-sm transition">Sign In</button>
            <button onclick="switchTab('register')" id="tab-register" class="flex-1 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-900 transition">Create Account</button>
        </div>

        <form id="loginForm" class="space-y-5">
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Work Email</label>
                <input type="email" id="loginEmail" class="input-field w-full p-3.5 rounded-xl mt-1.5 text-sm font-medium" placeholder="name@company.com" required>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Password</label>
                <input type="password" id="loginPass" class="input-field w-full p-3.5 rounded-xl mt-1.5 text-sm font-medium" placeholder="••••••••" required>
            </div>
            <button type="submit" class="btn-black w-full py-4 rounded-xl font-bold text-sm mt-2">Access Portal</button>
        </form>

        <form id="registerForm" class="space-y-5 hidden">
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Full Legal Name</label>
                <input type="text" id="regName" class="input-field w-full p-3.5 rounded-xl mt-1.5 text-sm font-medium" placeholder="e.g. John Doe" required>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Work Email</label>
                <input type="email" id="regEmail" class="input-field w-full p-3.5 rounded-xl mt-1.5 text-sm font-medium" placeholder="name@company.com" required>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Set Password</label>
                <input type="password" id="regPass" class="input-field w-full p-3.5 rounded-xl mt-1.5 text-sm font-medium" placeholder="••••••••" required>
            </div>
            <button type="submit" class="btn-black w-full py-4 rounded-xl font-bold text-sm mt-2">Create Account</button>
        </form>

        <p id="msg" class="text-center text-xs text-red-600 mt-6 font-medium min-h-[20px]"></p>
    </div>

    <script type="module">
        import { login, register } from './js/auth.js';
        import { supabase } from './js/supabase.js';

        window.switchTab = (tab) => {
            document.getElementById('msg').innerText = '';
            if(tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('tab-login').classList.add('bg-white', 'shadow-sm', 'font-semibold');
                document.getElementById('tab-login').classList.remove('text-gray-500', 'font-medium');
                document.getElementById('tab-register').classList.remove('bg-white', 'shadow-sm', 'font-semibold');
                document.getElementById('tab-register').classList.add('text-gray-500', 'font-medium');
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('tab-register').classList.add('bg-white', 'shadow-sm', 'font-semibold');
                document.getElementById('tab-register').classList.remove('text-gray-500', 'font-medium');
                document.getElementById('tab-login').classList.remove('bg-white', 'shadow-sm', 'font-semibold');
                document.getElementById('tab-login').classList.add('text-gray-500', 'font-medium');
            }
        };

        // --- SMART LOGIN LOGIC (MASTER FIX) ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value;
            
            document.getElementById('msg').innerText = '';
            btn.innerText = 'Verifying Identity...'; btn.disabled = true;

            try {
                // 1. Try Normal Login
                let { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });

                // 2. If Login Fails, Check if Invited
                if (error) {
                    const { data: invite } = await supabase.from('staff_invites').select('*').ilike('email', email).maybeSingle();

                    if (invite) {
                        // 3. User is Invited -> Register them automatically with the password they just typed
                        const { data: signUpData, error: signUpErr } = await supabase.auth.signUp({ 
                            email, 
                            password: pass // User sets their password here
                        });
                        
                        if (signUpErr) throw signUpErr;

                        // Force Login immediately
                        const secondAttempt = await supabase.auth.signInWithPassword({ email, password: pass });
                        if (secondAttempt.error) throw secondAttempt.error;
                        
                        data = secondAttempt.data; // Success
                    } else {
                        throw new Error("Invalid credentials or no account found.");
                    }
                }

                // 4. Link Invite to Profile & Redirect
                // (Trigger will handle profile creation, we just link the invite)
                await supabase.rpc('claim_my_invite', { email_to_check: email, user_id_to_link: data.user.id });
                
                // Check if they need Setup (First Time) or Dashboard
                const { data: profile } = await supabase.from('profiles').select('*').eq('id', data.user.id).single();
                
                if (!profile || !profile.organization_id) {
                    window.location.href = 'setup.html';
                } else {
                    window.location.href = 'dashboard.html';
                }

            } catch (err) {
                document.getElementById('msg').innerText = err.message;
                btn.innerText = 'Access Portal'; btn.disabled = false;
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value;

            btn.innerText = 'Initializing...'; btn.disabled = true;

            try {
                await register(email, pass, name);
                const loginData = await login(email, pass);
                window.location.href = 'setup.html';
            } catch (err) {
                document.getElementById('msg').innerText = err.message;
                btn.innerText = 'Create Account'; btn.disabled = false;
            }
        });
    </script>
</body>
</html>

